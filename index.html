<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURPS 스타일 RPG 전투 시스템</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
        }

        .game-container {
            flex: 2;
        }

        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: #2c3e50;
        }

        .map-container {
            position: relative;
            border: 2px solid #333;
            background-color: #e0e0e0;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .map {
            display: grid;
            grid-template-columns: repeat(15, 40px);
            grid-template-rows: repeat(10, 40px);
            gap: 1px;
        }

        .tile {
            width: 40px;
            height: 40px;
            background-color: #8BC34A;
            border: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .tile.water {
            background-color: #64B5F6;
        }

        .tile.mountain {
            background-color: #9E9E9E;
        }

        .tile.forest {
            background-color: #33691E;
        }

        .tile.selected {
            border: 2px solid yellow;
        }

        .character {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .character.player {
            background-color: #4CAF50;
            color: white;
        }

        .character.enemy {
            background-color: #F44336;
            color: white;
        }

        .character.selected {
            border: 2px solid yellow;
            box-shadow: 0 0 10px yellow;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #388E3C;
        }

        button:disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }

        .turn-info {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .skill-item {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f1f1f1;
            border-radius: 3px;
        }

        .game-log {
            height: 150px;
            overflow-y: auto;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .success {
            color: green;
        }

        .failure {
            color: red;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #ddd;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            position: relative;
            z-index: 1;
        }

        .tab-content {
            display: none;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0 5px 5px 5px;
            margin-top: -1px;
        }

        .tab-content.active {
            display: block;
        }

        #character-stats {
            margin-top: 15px;
        }

        .items-list, .skills-list {
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>GURPS 스타일 RPG 전투 시스템</h1>
    <div class="container">
        <div class="game-container">
            <div class="turn-info" id="turn-info">플레이어 턴</div>
            <div class="map-container">
                <div class="map" id="map"></div>
            </div>
            <div class="action-buttons">
                <button id="move-btn" disabled>이동 (M)</button>
                <button id="attack-btn" disabled>공격 (A)</button>
                <button id="skill-btn" disabled>스킬 사용 (S)</button>
                <button id="item-btn" disabled>아이템 사용 (I)</button>
                <button id="end-turn-btn">턴 종료 (E)</button>
            </div>
            <div class="game-log" id="game-log">
                <div class="log-entry">게임이 시작되었습니다.</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="tabs">
                <div class="tab active" data-tab="create">캐릭터 생성</div>
                <div class="tab" data-tab="view">캐릭터 정보</div>
            </div>

            <div class="tab-content active" id="create-tab">
                <h3>새로운 캐릭터 생성</h3>
                <form id="character-form">
                    <div class="form-group">
                        <label for="char-name">이름:</label>
                        <input type="text" id="char-name" required>
                    </div>
                    <div class="form-group">
                        <label for="char-type">타입:</label>
                        <select id="char-type">
                            <option value="player">플레이어</option>
                            <option value="enemy">적</option>
                        </select>
                    </div>
                    <h4>능력치</h4>
                    <div class="form-group">
                        <label for="char-st">힘 (ST):</label>
                        <input type="number" id="char-st" min="8" max="20" value="10">
                    </div>
                    <div class="form-group">
                        <label for="char-dx">민첩 (DX):</label>
                        <input type="number" id="char-dx" min="8" max="20" value="10">
                    </div>
                    <div class="form-group">
                        <label for="char-iq">지능 (IQ):</label>
                        <input type="number" id="char-iq" min="8" max="20" value="10">
                    </div>
                    <div class="form-group">
                        <label for="char-ht">체력 (HT):</label>
                        <input type="number" id="char-ht" min="8" max="20" value="10">
                    </div>
                    <div class="form-group">
                        <label for="char-hp">생명력 (HP):</label>
                        <input type="number" id="char-hp" min="1" max="30" value="10">
                    </div>
                    <div class="form-group">
                        <label for="new-skill">스킬 추가:</label>
                        <select id="new-skill">
                            <option value="">스킬 선택...</option>
                            <option value="broadsword">검술 (Broadsword)</option>
                            <option value="bow">활쏘기 (Bow)</option>
                            <option value="shield">방패 (Shield)</option>
                            <option value="stealth">은신 (Stealth)</option>
                            <option value="firstAid">응급처치 (First Aid)</option>
                        </select>
                        <input type="number" id="skill-level" min="8" max="20" value="10" placeholder="레벨">
                        <button type="button" id="add-skill-btn">추가</button>
                    </div>
                    <div class="skills-list" id="skills-list"></div>
                    
                    <div class="form-group">
                        <label for="new-item">아이템 추가:</label>
                        <select id="new-item">
                            <option value="">아이템 선택...</option>
                            <option value="sword">검</option>
                            <option value="bow">활</option>
                            <option value="shield">방패</option>
                            <option value="potion">체력 물약</option>
                            <option value="scroll">마법 스크롤</option>
                        </select>
                        <button type="button" id="add-item-btn">추가</button>
                    </div>
                    <div class="items-list" id="items-list"></div>
                    
                    <button type="submit" id="create-character-btn">캐릭터 생성</button>
                </form>
            </div>

            <div class="tab-content" id="view-tab">
                <h3>캐릭터 정보</h3>
                <div id="character-stats">
                    <p>캐릭터를 선택하세요.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 게임 상태 관리
        const gameState = {
            map: [],
            characters: [],
            selectedCharacter: null,
            currentTurn: 'player', // player 또는 enemy
            actionsPerformed: {
                move: false,
                attack: false,
                skill: false,
                item: false
            },
            selectedTile: null,
            moveMode: false,
            attackMode: false,
            skillMode: false,
            itemMode: false
        };

        // 지형 타입
        const terrainTypes = ['plain', 'water', 'mountain', 'forest'];
        
        // 맵 초기화
        function initializeMap() {
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = '';
            
            for (let y = 0; y < 10; y++) {
                gameState.map[y] = [];
                for (let x = 0; x < 15; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    
                    // 랜덤 지형 생성 (70% 평지, 10% 물, 10% 산, 10% 숲)
                    const terrainRoll = Math.random();
                    let terrainType = 'plain';
                    
                    if (terrainRoll > 0.9) {
                        terrainType = 'forest';
                        tile.classList.add('forest');
                    } else if (terrainRoll > 0.8) {
                        terrainType = 'mountain';
                        tile.classList.add('mountain');
                    } else if (terrainRoll > 0.7) {
                        terrainType = 'water';
                        tile.classList.add('water');
                    }
                    
                    gameState.map[y][x] = {
                        type: terrainType,
                        x: x,
                        y: y,
                        element: tile
                    };
                    
                    // 타일 클릭 이벤트
                    tile.addEventListener('click', () => onTileClick(x, y));
                    
                    mapElement.appendChild(tile);
                }
            }
        }

        // 타일 클릭 이벤트 핸들러
        function onTileClick(x, y) {
            // 이전에 선택된 타일의 선택 상태 해제
            if (gameState.selectedTile) {
                gameState.selectedTile.element.classList.remove('selected');
            }
            
            // 현재 타일 선택
            gameState.selectedTile = gameState.map[y][x];
            gameState.selectedTile.element.classList.add('selected');
            
            // 이동 모드가 활성화되었고, 캐릭터가 선택된 상태라면 이동 시도
            if (gameState.moveMode && gameState.selectedCharacter) {
                moveCharacter(gameState.selectedCharacter, x, y);
            }
            
            // 공격 모드가 활성화되었고, 캐릭터가 선택된 상태라면 공격 대상 확인
            if (gameState.attackMode && gameState.selectedCharacter) {
                const targetCharacter = getCharacterAtPosition(x, y);
                if (targetCharacter && targetCharacter !== gameState.selectedCharacter) {
                    // 적 캐릭터인지 확인
                    if (targetCharacter.type !== gameState.selectedCharacter.type) {
                        attackCharacter(gameState.selectedCharacter, targetCharacter);
                    } else {
                        addToLog("같은 편은 공격할 수 없습니다!");
                    }
                }
            }
        }

        // 캐릭터 생성
        function createCharacter(name, type, stats, skills, items) {
            const character = {
                id: Date.now(), // 고유 ID
                name: name,
                type: type,
                stats: stats,
                skills: skills || [],
                items: items || [],
                x: null,
                y: null,
                element: null,
                alive: true
            };
            
            const charElement = document.createElement('div');
            charElement.className = `character ${type}`;
            charElement.textContent = name.charAt(0).toUpperCase();
            charElement.addEventListener('click', () => selectCharacter(character));
            
            character.element = charElement;
            gameState.characters.push(character);
            
            return character;
        }

        // 캐릭터를 맵에 배치
        function placeCharacter(character, x, y) {
            // 이미 캐릭터가 있는지 확인
            if (getCharacterAtPosition(x, y)) {
                addToLog("이미 다른 캐릭터가 해당 위치에 있습니다.");
                return false;
            }
            
            // 물 지형인지 확인
            if (gameState.map[y][x].type === 'water') {
                addToLog("물 위에는 캐릭터를 배치할 수 없습니다.");
                return false;
            }
            
            // 이전 위치에서 제거
            if (character.x !== null && character.y !== null) {
                character.element.remove();
            }
            
            // 새 위치에 배치
            character.x = x;
            character.y = y;
            character.element.style.left = `${x * 40 + 5}px`;
            character.element.style.top = `${y * 40 + 5}px`;
            document.querySelector('.map-container').appendChild(character.element);
            
            addToLog(`${character.name}이(가) (${x}, ${y}) 위치에 배치되었습니다.`);
            return true;
        }

        // 캐릭터 선택
        function selectCharacter(character) {
            // 해당 턴에 해당하는 캐릭터만 선택 가능
            if (gameState.currentTurn === 'player' && character.type !== 'player') {
                addToLog("플레이어 턴에는 플레이어 캐릭터만 선택할 수 있습니다.");
                return;
            } else if (gameState.currentTurn === 'enemy' && character.type !== 'enemy') {
                addToLog("적 턴에는 적 캐릭터만 선택할 수 있습니다.");
                return;
            }
            
            // 이전에 선택된 캐릭터의 선택 상태 해제
            if (gameState.selectedCharacter) {
                gameState.selectedCharacter.element.classList.remove('selected');
            }
            
            // 새 캐릭터 선택
            gameState.selectedCharacter = character;
            character.element.classList.add('selected');
            
            // 캐릭터 정보 표시
            displayCharacterStats(character);
            
            // 액션 버튼 활성화
            updateActionButtons();
        }

        // 캐릭터 이동
        function moveCharacter(character, x, y) {
            // 이미 이동을 수행했는지 확인
            if (gameState.actionsPerformed.move) {
                addToLog("이번 턴에 이미 이동을 수행했습니다.");
                gameState.moveMode = false;
                return;
            }
            
            // 이동 가능 거리 계산 (맨해튼 거리 사용)
            const distance = Math.abs(character.x - x) + Math.abs(character.y - y);
            const maxMove = 2; // 최대 이동 거리
            
            if (distance > maxMove) {
                addToLog(`최대 ${maxMove}칸까지만 이동할 수 있습니다.`);
                return;
            }
            
            // 물 지형인지 확인
            if (gameState.map[y][x].type === 'water') {
                addToLog("물 위로는 이동할 수 없습니다.");
                return;
            }
            
            // 이미 다른 캐릭터가 있는지 확인
            if (getCharacterAtPosition(x, y)) {
                addToLog("다른 캐릭터가 있는 위치로는 이동할 수 없습니다.");
                return;
            }
            
            // 이동 수행
            const result = placeCharacter(character, x, y);
            if (result) {
                gameState.actionsPerformed.move = true;
                gameState.moveMode = false;
                updateActionButtons();
            }
        }

        // 특정 위치에 있는 캐릭터 찾기
        function getCharacterAtPosition(x, y) {
            return gameState.characters.find(char => char.x === x && char.y === y && char.alive);
        }

        // 캐릭터 공격
        function attackCharacter(attacker, defender) {
            // 이미 공격을 수행했는지 확인
            if (gameState.actionsPerformed.attack) {
                addToLog("이번 턴에 이미 공격을 수행했습니다.");
                gameState.attackMode = false;
                return;
            }
            
            // 공격 거리 계산
            const distance = Math.abs(attacker.x - defender.x) + Math.abs(attacker.y - defender.y);
            
            // 근접 공격은 거리 1, 원거리 공격은 더 멀리 가능
            const hasRangedWeapon = attacker.items.some(item => item.name === '활');
            const maxRange = hasRangedWeapon ? 5 : 1;
            
            if (distance > maxRange) {
                addToLog(`공격 범위를 벗어났습니다. 최대 ${maxRange}칸까지 공격할 수 있습니다.`);
                return;
            }
            
            // GURPS 전투 규칙에 따른 공격 판정
            // 기본적으로 3d6를 굴려서 DX보다 낮거나 같으면 성공
            let attackRoll = rollDice(3, 6);
            let weaponSkill = 0;
            
            // 무기 스킬 보너스 적용
            const weaponSkillObj = attacker.skills.find(s => s.name === '검술' || s.name === '활쏘기');
            if (weaponSkillObj) {
                weaponSkill = weaponSkillObj.level - 10; // 스킬 레벨에서 10을 뺀 값이 보너스
            }
            
            const attackTarget = attacker.stats.dx + weaponSkill;
            const hitSuccess = attackRoll <= attackTarget;
            
            // 명중 여부에 따른 처리
            if (hitSuccess) {
                // 데미지 계산 (기본 공격력 + 무기 데미지 + 힘 보너스)
                let baseDamage = Math.floor(attacker.stats.st / 4);
                let weaponDamage = 2; // 기본 무기 데미지
                
                // 무기에 따른 데미지 보너스
                if (attacker.items.some(item => item.name === '검')) {
                    weaponDamage += 2;
                } else if (attacker.items.some(item => item.name === '활')) {
                    weaponDamage += 1;
                }
                
                const totalDamage = baseDamage + weaponDamage;
                
                // 방어 판정
                let defenseRoll = rollDice(3, 6);
                let shieldBonus = defender.items.some(item => item.name === '방패') ? 2 : 0;
                let defenseTarget = Math.floor(defender.stats.dx / 2) + shieldBonus;
                let defenseSuccess = defenseRoll <= defenseTarget;
                
                if (defenseSuccess) {
                    addToLog(`${defender.name}이(가) 공격을 방어했습니다!`, 'success');
                } else {
                    // 데미지 적용
                    defender.stats.hp -= totalDamage;
                    addToLog(`${attacker.name}의 공격이 ${defender.name}에게 ${totalDamage}의 데미지를 입혔습니다!`, 'success');
                    
                    // 생명력이 0 이하로 떨어졌는지 확인
                    if (defender.stats.hp <= 0) {
                        defender.alive = false;
                        defender.element.style.opacity = 0.5;
                        addToLog(`${defender.name}이(가) 쓰러졌습니다!`, 'success');
                        
                        // 게임 종료 조건 확인
                        checkGameEnd();
                    }
                }
            } else {
                addToLog(`${attacker.name}의 공격이 빗나갔습니다! (굴림: ${attackRoll}, 목표: ${attackTarget})`, 'failure');
            }
            
            // 공격 액션 완료 처리
            gameState.actionsPerformed.attack = true;
            gameState.attackMode = false;
            updateActionButtons();
        }

        // 주사위 굴리기 함수
        function rollDice(count, sides) {
            let total = 0;
            for (let i = 0; i < count; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }

        // 게임 종료 조건 확인
        function checkGameEnd() {
            const playersAlive = gameState.characters.some(char => char.type === 'player' && char.alive);
            const enemiesAlive = gameState.characters.some(char => char.type === 'enemy' && char.alive);
            
            if (!playersAlive) {
                addToLog("게임 오버! 모든 플레이어 캐릭터가 쓰러졌습니다.", 'failure');
                disableAllActions();
            } else if (!enemiesAlive) {
                addToLog("승리! 모든 적을 물리쳤습니다.", 'success');
                disableAllActions();
            }
        }

        // 모든 액션 비활성화
        function disableAllActions() {
            document.getElementById('move-btn').disabled = true;
            document.getElementById('attack-btn').disabled = true;
            document.getElementById('skill-btn').disabled = true;
            document.getElementById('item-btn').disabled = true;
            document.getElementById('end-turn-btn').disabled = true;
        }

        // 액션 버튼 상태 업데이트
        function updateActionButtons() {
            const moveBtn = document.getElementById('move-btn');
            const attackBtn = document.getElementById('attack-btn');
            const skillBtn = document.getElementById('skill-btn');
            const itemBtn = document.getElementById('item-btn');
            
            // 캐릭터가 선택되어 있고 해당 턴의 캐릭터인 경우에만 활성화
            const canAct = gameState.selectedCharacter && 
                          ((gameState.currentTurn === 'player' && gameState.selectedCharacter.type === 'player') ||
                           (gameState.currentTurn === 'enemy' && gameState.selectedCharacter.type === 'enemy'));
            
            moveBtn.disabled = !canAct || gameState.actionsPerformed.move;
            attackBtn.disabled = !canAct || gameState.actionsPerformed.attack;
            skillBtn.disabled = !canAct || gameState.actionsPerformed.skill || !gameState.selectedCharacter?.skills.length;
            itemBtn.disabled = !canAct || gameState.actionsPerformed.item || !gameState.selectedCharacter?.items.length;
        }

        // 턴 종료
        function endTurn() {
            // 턴 전환
            gameState.currentTurn = gameState.currentTurn === 'player' ? 'enemy' : 'player';
            
            // 행동 초기화
            gameState.actionsPerformed = {
                move: false,
                attack: false,
                skill: false,
                item: false
            };
            
            // 턴 정보 업데이트
            document.getElementById('turn-info').textContent = 
                gameState.currentTurn === 'player' ? '플레이어 턴' : '적 턴';
            
            // 모드 초기화
            gameState.moveMode = false;
            gameState.attackMode = false;
            gameState.skillMode = false;
            gameState.itemMode = false;
            
            // 선택 상태 초기화
            if (gameState.selectedCharacter) {
                gameState.selectedCharacter.element.classList.remove('selected');
                gameState.selectedCharacter = null;
            }
            
            if (gameState.selectedTile) {
                gameState.selectedTile.element.classList.remove('selected');
                gameState.selectedTile = null;
            }
            
            addToLog(`${gameState.currentTurn === 'player' ? '플레이어' : '적'} 턴이 시작되었습니다.`);
            
            // 적 턴일 경우 AI 행동
            if (gameState.currentTurn === 'enemy') {
                setTimeout(performEnemyActions, 1000);
            }
            
            // 버튼 상태 업데이트
            updateActionButtons();
        }

        // 적 AI 행동
        function performEnemyActions() {
            const enemies = gameState.characters.filter(char => char.type === 'enemy' && char.alive);
            
            if (enemies.length === 0) {
                endTurn();
                return;
            }
            
            // 첫 번째 적만 행동
            const enemy = enemies[0];
            selectCharacter(enemy);
            
            // 가장 가까운 플레이어 찾기
            const players = gameState.characters.filter(char => char.type === 'player' && char.alive);
            if (players.length === 0) {
                endTurn();
                return;
            }
            
            let closestPlayer = null;
            let minDistance = Infinity;
            
            for (const player of players) {
                const distance = Math.abs(enemy.x - player.x) + Math.abs(enemy.y - player.y);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPlayer = player;
                }
            }
            
            // 공격 범위 내에 있으면 공격
            const hasRangedWeapon = enemy.items.some(item => item.name === '활');
            const attackRange = hasRangedWeapon ? 5 : 1;
            
            if (minDistance <= attackRange) {
                // 공격 모드 활성화
                toggleAttackMode();
                attackCharacter(enemy, closestPlayer);
            } else {
                // 이동 모드 활성화
                toggleMoveMode();
                
                // 플레이어 방향으로 이동
                const dx = closestPlayer.x > enemy.x ? 1 : (closestPlayer.x < enemy.x ? -1 : 0);
                const dy = closestPlayer.y > enemy.y ? 1 : (closestPlayer.y < enemy.y ? -1 : 0);
                
                // 이동할 위치 계산
                let newX = enemy.x + dx;
                let newY = enemy.y + dy;
                
                // 맵 범위 안에 있는지 확인
                newX = Math.max(0, Math.min(14, newX));
                newY = Math.max(0, Math.min(9, newY));
                
                // 이미 다른 캐릭터가 있거나 물 지형인 경우 다른 방향 시도
                if (getCharacterAtPosition(newX, newY) || gameState.map[newY][newX].type === 'water') {
                    if (dx !== 0) {
                        newX = enemy.x;
                    } else if (dy !== 0) {
                        newY = enemy.y;
                    }
                }
                
                // 이동
                moveCharacter(enemy, newX, newY);
            }
            
            // 1초 후 턴 종료
            setTimeout(endTurn, 1000);
        }

        // 게임 로그 추가
        function addToLog(message, className = '') {
            const logElement = document.getElementById('game-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${className}`;
            logEntry.textContent = message;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 캐릭터 정보 표시
        function displayCharacterStats(character) {
            const statsElement = document.getElementById('character-stats');
            
            if (!character) {
                statsElement.innerHTML = '<p>캐릭터를 선택하세요.</p>';
                return;
            }
            
            let html = `
                <h4>${character.name} (${character.type === 'player' ? '플레이어' : '적'})</h4>
                <p>위치: (${character.x}, ${character.y})</p>
                <h5>능력치</h5>
                <ul>
                    <li>힘 (ST): ${character.stats.st}</li>
                    <li>민첩 (DX): ${character.stats.dx}</li>
                    <li>지능 (IQ): ${character.stats.iq}</li>
                    <li>체력 (HT): ${character.stats.ht}</li>
                    <li>생명력 (HP): ${character.stats.hp}</li>
                </ul>
            `;
            
            if (character.skills.length > 0) {
                html += '<h5>스킬</h5><ul>';
                character.skills.forEach(skill => {
                    html += `<li>${skill.name} (레벨 ${skill.level})</li>`;
                });
                html += '</ul>';
            }
            
            if (character.items.length > 0) {
                html += '<h5>아이템</h5><ul>';
                character.items.forEach(item => {
                    html += `<li>${item.name}</li>`;
                });
                html += '</ul>';
            }
            
            statsElement.innerHTML = html;
            
            // 상태 탭으로 전환
            document.querySelector('.tab[data-tab="view"]').click();
        }

        // 이동 모드 토글
        function toggleMoveMode() {
            gameState.moveMode = !gameState.moveMode;
            gameState.attackMode = false;
            gameState.skillMode = false;
            gameState.itemMode = false;
            
            // 이동 버튼 시각적 피드백
            const moveBtn = document.getElementById('move-btn');
            if (gameState.moveMode) {
                moveBtn.style.backgroundColor = '#2196F3';
                addToLog("이동할 타일을 선택하세요.");
            } else {
                moveBtn.style.backgroundColor = '';
            }
            
            // 다른 버튼 초기화
            document.getElementById('attack-btn').style.backgroundColor = '';
            document.getElementById('skill-btn').style.backgroundColor = '';
            document.getElementById('item-btn').style.backgroundColor = '';
        }

        // 공격 모드 토글
        function toggleAttackMode() {
            gameState.attackMode = !gameState.attackMode;
            gameState.moveMode = false;
            gameState.skillMode = false;
            gameState.itemMode = false;
            
            // 공격 버튼 시각적 피드백
            const attackBtn = document.getElementById('attack-btn');
            if (gameState.attackMode) {
                attackBtn.style.backgroundColor = '#F44336';
                addToLog("공격할 대상을 선택하세요.");
            } else {
                attackBtn.style.backgroundColor = '';
            }
            
            // 다른 버튼 초기화
            document.getElementById('move-btn').style.backgroundColor = '';
            document.getElementById('skill-btn').style.backgroundColor = '';
            document.getElementById('item-btn').style.backgroundColor = '';
        }

        // 스킬 사용 함수
        function useSkill(character, skillName, target) {
            // 이미 스킬을 사용했는지 확인
            if (gameState.actionsPerformed.skill) {
                addToLog("이번 턴에 이미 스킬을 사용했습니다.");
                gameState.skillMode = false;
                return;
            }
            
            // 캐릭터가 해당 스킬을 가지고 있는지 확인
            const skill = character.skills.find(s => s.name === skillName);
            if (!skill) {
                addToLog(`${character.name}은(는) ${skillName} 스킬을 가지고 있지 않습니다.`);
                return;
            }
            
            // 스킬 효과 구현
            switch (skillName) {
                case '검술':
                    // 검술: 공격 성공률 증가
                    addToLog(`${character.name}이(가) 검술 스킬을 사용했습니다. 다음 공격의 명중률이 증가합니다.`);
                    character.tempBonus = {type: 'attack', value: 2};
                    break;
                case '활쏘기':
                    // 활쏘기: 원거리 공격
                    if (!target) {
                        addToLog("타겟을 선택해야 합니다.");
                        return;
                    }
                    const distance = Math.abs(character.x - target.x) + Math.abs(character.y - target.y);
                    if (distance > 5) {
                        addToLog("대상이 사정거리를 벗어났습니다.");
                        return;
                    }
                    
                    addToLog(`${character.name}이(가) 정확한 활쏘기 스킬을 사용했습니다.`);
                    
                    // 데미지 계산 및 적용
                    const damage = Math.floor(skill.level / 3) + rollDice(1, 6);
                    target.stats.hp -= damage;
                    addToLog(`${target.name}에게 ${damage}의 데미지를 입혔습니다!`, 'success');
                    
                    // 생명력 확인
                    if (target.stats.hp <= 0) {
                        target.alive = false;
                        target.element.style.opacity = 0.5;
                        addToLog(`${target.name}이(가) 쓰러졌습니다!`, 'success');
                        checkGameEnd();
                    }
                    break;
                case '방패':
                    // 방패: 방어력 증가
                    addToLog(`${character.name}이(가) 방패 스킬을 사용했습니다. 다음 턴까지 방어력이 증가합니다.`);
                    character.tempBonus = {type: 'defense', value: 3, turns: 1};
                    break;
                case '은신':
                    // 은신: 다음 턴에 적에게 공격받을 확률 감소
                    addToLog(`${character.name}이(가) 은신 스킬을 사용했습니다. 다음 턴에 적에게 발견될 확률이 감소합니다.`);
                    character.tempBonus = {type: 'stealth', value: 5, turns: 1};
                    break;
                case '응급처치':
                    // 응급처치: HP 회복
                    const healAmount = Math.floor(skill.level / 2);
                    character.stats.hp += healAmount;
                    addToLog(`${character.name}이(가) 응급처치 스킬을 사용했습니다. ${healAmount} HP를 회복했습니다!`, 'success');
                    break;
                default:
                    addToLog(`${skillName} 스킬 효과가 구현되지 않았습니다.`);
                    return;
            }
            
            // 스킬 사용 처리
            gameState.actionsPerformed.skill = true;
            gameState.skillMode = false;
            updateActionButtons();
        }

        // 아이템 사용 함수
        function useItem(character, itemName) {
            // 이미 아이템을 사용했는지 확인
            if (gameState.actionsPerformed.item) {
                addToLog("이번 턴에 이미 아이템을 사용했습니다.");
                gameState.itemMode = false;
                return;
            }
            
            // 캐릭터가 해당 아이템을 가지고 있는지 확인
            const itemIndex = character.items.findIndex(item => item.name === itemName);
            if (itemIndex === -1) {
                addToLog(`${character.name}은(는) ${itemName}을(를) 가지고 있지 않습니다.`);
                return;
            }
            
            // 아이템 효과 구현
            switch (itemName) {
                case '체력 물약':
                    // 체력 회복
                    const healAmount = 5;
                    character.stats.hp += healAmount;
                    addToLog(`${character.name}이(가) 체력 물약을 사용했습니다. ${healAmount} HP를 회복했습니다!`, 'success');
                    
                    // 아이템 소모
                    character.items.splice(itemIndex, 1);
                    break;
                case '마법 스크롤':
                    // 주변 적에게 데미지
                    const scrollDamage = 3;
                    let hitCount = 0;
                    
                    // 주변 2칸 내의 모든 적에게 데미지
                    gameState.characters.forEach(target => {
                        if (target.type !== character.type && target.alive) {
                            const distance = Math.abs(character.x - target.x) + Math.abs(character.y - target.y);
                            if (distance <= 2) {
                                target.stats.hp -= scrollDamage;
                                hitCount++;
                                
                                // 생명력 확인
                                if (target.stats.hp <= 0) {
                                    target.alive = false;
                                    target.element.style.opacity = 0.5;
                                    addToLog(`${target.name}이(가) 쓰러졌습니다!`, 'success');
                                }
                            }
                        }
                    });
                    
                    addToLog(`${character.name}이(가) 마법 스크롤을 사용했습니다. ${hitCount}명의 적에게 ${scrollDamage}의 데미지를 입혔습니다!`, 'success');
                    
                    // 아이템 소모
                    character.items.splice(itemIndex, 1);
                    
                    // 게임 종료 조건 확인
                    checkGameEnd();
                    break;
                default:
                    // 이 외의 아이템은 장비 아이템으로 간주
                    addToLog(`${itemName}은(는) 장비 아이템입니다. 자동으로 적용됩니다.`);
                    return;
            }
            
            // 아이템 사용 처리
            gameState.actionsPerformed.item = true;
            gameState.itemMode = false;
            updateActionButtons();
            
            // 캐릭터 정보 갱신
            displayCharacterStats(character);
        }

        // 스킬 모드 토글
        function toggleSkillMode() {
            if (!gameState.selectedCharacter || gameState.selectedCharacter.skills.length === 0) {
                addToLog("사용할 수 있는 스킬이 없습니다.");
                return;
            }
            
            gameState.skillMode = !gameState.skillMode;
            gameState.moveMode = false;
            gameState.attackMode = false;
            gameState.itemMode = false;
            
            // 스킬 버튼 시각적 피드백
            const skillBtn = document.getElementById('skill-btn');
            if (gameState.skillMode) {
                skillBtn.style.backgroundColor = '#9C27B0';
                
                // 스킬 선택 UI 표시
                let skillList = gameState.selectedCharacter.skills;
                let skillHtml = '<div class="skill-selection"><p>사용할 스킬을 선택하세요:</p>';
                
                skillList.forEach(skill => {
                    skillHtml += `<button class="skill-button" onclick="useSkill('${skill.name}')">${skill.name} (레벨 ${skill.level})</button>`;
                });
                
                skillHtml += '</div>';
                
                // 임시 UI 엘리먼트 생성 및 표시
                let tempElement = document.createElement('div');
                tempElement.id = 'temp-skill-ui';
                tempElement.innerHTML = skillHtml;
                tempElement.style.position = 'absolute';
                tempElement.style.top = '50%';
                tempElement.style.left = '50%';
                tempElement.style.transform = 'translate(-50%, -50%)';
                tempElement.style.backgroundColor = '#fff';
                tempElement.style.padding = '15px';
                tempElement.style.borderRadius = '5px';
                tempElement.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
                tempElement.style.zIndex = '100';
                
                document.body.appendChild(tempElement);
                
                // 스킬 버튼 클릭 이벤트 정의
                window.useSkill = function(skillName) {
                    const target = gameState.attackMode ? getCharacterAtPosition(gameState.selectedTile.x, gameState.selectedTile.y) : null;
                    useSkill(gameState.selectedCharacter, skillName, target);
                    document.getElementById('temp-skill-ui').remove();
                    delete window.useSkill;
                };
            } else {
                skillBtn.style.backgroundColor = '';
                // 임시 UI 제거
                const tempElement = document.getElementById('temp-skill-ui');
                if (tempElement) {
                    tempElement.remove();
                    delete window.useSkill;
                }
            }
            
            // 다른 버튼 초기화
            document.getElementById('move-btn').style.backgroundColor = '';
            document.getElementById('attack-btn').style.backgroundColor = '';
            document.getElementById('item-btn').style.backgroundColor = '';
        }

        // 아이템 모드 토글
        function toggleItemMode() {
            if (!gameState.selectedCharacter || gameState.selectedCharacter.items.length === 0) {
                addToLog("사용할 수 있는 아이템이 없습니다.");
                return;
            }
            
            gameState.itemMode = !gameState.itemMode;
            gameState.moveMode = false;
            gameState.attackMode = false;
            gameState.skillMode = false;
            
            // 아이템 버튼 시각적 피드백
            const itemBtn = document.getElementById('item-btn');
            if (gameState.itemMode) {
                itemBtn.style.backgroundColor = '#FF9800';
                
                // 아이템 선택 UI 표시
                let itemList = gameState.selectedCharacter.items;
                let itemHtml = '<div class="item-selection"><p>사용할 아이템을 선택하세요:</p>';
                
                // 아이템 이름 중복 처리를 위한 카운팅
                const itemCounts = {};
                itemList.forEach(item => {
                    if (!itemCounts[item.name]) itemCounts[item.name] = 0;
                    itemCounts[item.name]++;
                });
                
                // 중복을 제거한 아이템 목록 생성
                const uniqueItems = [];
                for (const itemName in itemCounts) {
                    uniqueItems.push({
                        name: itemName,
                        count: itemCounts[itemName]
                    });
                }
                
                uniqueItems.forEach(item => {
                    itemHtml += `<button class="item-button" onclick="useItemFromUI('${item.name}')">${item.name} (${item.count}개)</button>`;
                });
                
                itemHtml += '</div>';
                
                // 임시 UI 엘리먼트 생성 및 표시
                let tempElement = document.createElement('div');
                tempElement.id = 'temp-item-ui';
                tempElement.innerHTML = itemHtml;
                tempElement.style.position = 'absolute';
                tempElement.style.top = '50%';
                tempElement.style.left = '50%';
                tempElement.style.transform = 'translate(-50%, -50%)';
                tempElement.style.backgroundColor = '#fff';
                tempElement.style.padding = '15px';
                tempElement.style.borderRadius = '5px';
                tempElement.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
                tempElement.style.zIndex = '100';
                
                document.body.appendChild(tempElement);
                
                // 아이템 버튼 클릭 이벤트 정의
                window.useItemFromUI = function(itemName) {
                    useItem(gameState.selectedCharacter, itemName);
                    document.getElementById('temp-item-ui').remove();
                    delete window.useItemFromUI;
                };
            } else {
                itemBtn.style.backgroundColor = '';
                // 임시 UI 제거
                const tempElement = document.getElementById('temp-item-ui');
                if (tempElement) {
                    tempElement.remove();
                    delete window.useItemFromUI;
                }
            }
            
            // 다른 버튼 초기화
            document.getElementById('move-btn').style.backgroundColor = '';
            document.getElementById('attack-btn').style.backgroundColor = '';
            document.getElementById('skill-btn').style.backgroundColor = '';
        }

        // 초기화 함수
        function init() {
            // 맵 초기화
            initializeMap();
            
            // 이벤트 리스너 설정
            document.getElementById('move-btn').addEventListener('click', toggleMoveMode);
            document.getElementById('attack-btn').addEventListener('click', toggleAttackMode);
            document.getElementById('skill-btn').addEventListener('click', toggleSkillMode);
            document.getElementById('item-btn').addEventListener('click', toggleItemMode);
            document.getElementById('end-turn-btn').addEventListener('click', endTurn);
            
            // 캐릭터 생성 폼 이벤트 리스너
            document.getElementById('character-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('char-name').value;
                const type = document.getElementById('char-type').value;
                const stats = {
                    st: parseInt(document.getElementById('char-st').value),
                    dx: parseInt(document.getElementById('char-dx').value),
                    iq: parseInt(document.getElementById('char-iq').value),
                    ht: parseInt(document.getElementById('char-ht').value),
                    hp: parseInt(document.getElementById('char-hp').value)
                };
                
                // 스킬 목록 가져오기
                const skillsElements = document.querySelectorAll('#skills-list .skill-item');
                const skills = Array.from(skillsElements).map(el => ({
                    name: el.dataset.name,
                    level: parseInt(el.dataset.level)
                }));
                
                // 아이템 목록 가져오기
                const itemsElements = document.querySelectorAll('#items-list .item-item');
                const items = Array.from(itemsElements).map(el => ({
                    name: el.dataset.name
                }));
                
                // 캐릭터 생성
                const character = createCharacter(name, type, stats, skills, items);
                
                // 캐릭터 자동 배치
                let placed = false;
                // 플레이어는 왼쪽에, 적은 오른쪽에 배치
                let startX = type === 'player' ? 0 : 10;
                let endX = type === 'player' ? 5 : 14;
                
                for (let y = 0; y < 10 && !placed; y++) {
                    for (let x = startX; x <= endX && !placed; x++) {
                        if (!getCharacterAtPosition(x, y) && gameState.map[y][x].type !== 'water') {
                            placed = placeCharacter(character, x, y);
                        }
                    }
                }
                
                if (!placed) {
                    // 전체 맵에서 빈 자리 찾기
                    for (let y = 0; y < 10 && !placed; y++) {
                        for (let x = 0; x < 15 && !placed; x++) {
                            if (!getCharacterAtPosition(x, y) && gameState.map[y][x].type !== 'water') {
                                placed = placeCharacter(character, x, y);
                            }
                        }
                    }
                }
                
                if (!placed) {
                    addToLog("캐릭터를 배치할 공간이 없습니다.");
                }
                
                // 폼 초기화
                document.getElementById('char-name').value = '';
                document.getElementById('char-st').value = '10';
                document.getElementById('char-dx').value = '10';
                document.getElementById('char-iq').value = '10';
                document.getElementById('char-ht').value = '10';
                document.getElementById('char-hp').value = '10';
                document.getElementById('skills-list').innerHTML = '';
                document.getElementById('items-list').innerHTML = '';
            });
            
            // 스킬 추가 버튼 이벤트
            document.getElementById('add-skill-btn').addEventListener('click', function() {
                const skillSelect = document.getElementById('new-skill');
                const skillName = skillSelect.options[skillSelect.selectedIndex].text;
                const skillValue = skillSelect.value;
                const skillLevel = parseInt(document.getElementById('skill-level').value);
                
                if (!skillValue) {
                    alert('스킬을 선택하세요.');
                    return;
                }
                
                const skillsContainer = document.getElementById('skills-list');
                const skillElement = document.createElement('div');
                skillElement.className = 'skill-item';
                skillElement.dataset.name = skillName;
                skillElement.dataset.level = skillLevel;
                skillElement.innerHTML = `${skillName} (레벨 ${skillLevel}) <button type="button" class="remove-skill">제거</button>`;
                
                // 제거 버튼 이벤트
                skillElement.querySelector('.remove-skill').addEventListener('click', function() {
                    skillElement.remove();
                });
                
                skillsContainer.appendChild(skillElement);
                skillSelect.selectedIndex = 0;
            });
            
            // 아이템 추가 버튼 이벤트
            document.getElementById('add-item-btn').addEventListener('click', function() {
                const itemSelect = document.getElementById('new-item');
                const itemName = itemSelect.options[itemSelect.selectedIndex].text;
                const itemValue = itemSelect.value;
                
                if (!itemValue) {
                    alert('아이템을 선택하세요.');
                    return;
                }
                
                const itemsContainer = document.getElementById('items-list');
                const itemElement = document.createElement('div');
                itemElement.className = 'item-item';
                itemElement.dataset.name = itemName;
                itemElement.innerHTML = `${itemName} <button type="button" class="remove-item">제거</button>`;
                
                // 제거 버튼 이벤트
                itemElement.querySelector('.remove-item').addEventListener('click', function() {
                    itemElement.remove();
                });
                
                itemsContainer.appendChild(itemElement);
                itemSelect.selectedIndex = 0;
            });
            
            // 탭 전환 이벤트
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 모든 탭과 콘텐츠 비활성화
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 클릭한 탭과 해당 콘텐츠 활성화
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // 키보드 단축키 설정
            document.addEventListener('keydown', function(e) {
                if (!gameState.selectedCharacter) return;
                
                switch (e.key.toLowerCase()) {
                    case 'm':
                        // 이동
                        if (!document.getElementById('move-btn').disabled) {
                            toggleMoveMode();
                        }
                        break;
                    case 'a':
                        // 공격
                        if (!document.getElementById('attack-btn').disabled) {
                            toggleAttackMode();
                        }
                        break;
                    case 's':
                        // 스킬
                        if (!document.getElementById('skill-btn').disabled) {
                            toggleSkillMode();
                        }
                        break;
                    case 'i':
                        // 아이템
                        if (!document.getElementById('item-btn').disabled) {
                            toggleItemMode();
                        }
                        break;
                    case 'e':
                        // 턴 종료
                        if (!document.getElementById('end-turn-btn').disabled) {
                            endTurn();
                        }
                        break;
                    case 'arrowup':
                        // 위로 이동
                        if (gameState.moveMode && gameState.selectedCharacter.y > 0) {
                            moveCharacter(gameState.selectedCharacter, gameState.selectedCharacter.x, gameState.selectedCharacter.y - 1);
                        }
                        break;
                    case 'arrowdown':
                        // 아래로 이동
                        if (gameState.moveMode && gameState.selectedCharacter.y < 9) {
                            moveCharacter(gameState.selectedCharacter, gameState.selectedCharacter.x, gameState.selectedCharacter.y + 1);
                        }
                        break;
                    case 'arrowleft':
                        // 왼쪽으로 이동
                        if (gameState.moveMode && gameState.selectedCharacter.x > 0) {
                            moveCharacter(gameState.selectedCharacter, gameState.selectedCharacter.x - 1, gameState.selectedCharacter.y);
                        }
                        break;
                    case 'arrowright':
                        // 오른쪽으로 이동
                        if (gameState.moveMode && gameState.selectedCharacter.x < 14) {
                            moveCharacter(gameState.selectedCharacter, gameState.selectedCharacter.x + 1, gameState.selectedCharacter.y);
                        }
                        break;
                }
            });
            
            // 기본 플레이어와 적 캐릭터 생성
            const defaultPlayer = createCharacter("용사", "player", {
                st: 12,
                dx: 13,
                iq: 10,
                ht: 11,
                hp: 15
            }, [
                {name: "검술", level: 14},
                {name: "방패", level: 12}
            ], [
                {name: "검"},
                {name: "방패"},
                {name: "체력 물약"}
            ]);
            
            const defaultEnemy = createCharacter("고블린", "enemy", {
                st: 10,
                dx: 12,
                iq: 8,
                ht: 10,
                hp: 10
            }, [
                {name: "검술", level: 11}
            ], [
                {name: "검"}
            ]);
            
            // 기본 캐릭터 배치
            placeCharacter(defaultPlayer, 2, 4);
            placeCharacter(defaultEnemy, 12, 4);
            
            addToLog("게임이 준비되었습니다. 플레이어 턴입니다.");
        }

        // 페이지 로드 시 초기화
        window.onload = init;
    </script>
</body>
</html>
